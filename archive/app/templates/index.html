<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockly Python Editor</title>
    <script defer src="{{ url_for('static', filename='blockly/node_modules/blockly/blockly_compressed.js') }}"></script>
    <script defer src="{{ url_for('static', filename='blockly/node_modules/blockly/blocks_compressed.js') }}"></script>
    <script defer src="{{ url_for('static', filename='blockly/node_modules/blockly/python_compressed.js') }}"></script>
    <script defer src="{{ url_for('static', filename='blockly/node_modules/blockly/msg/en.js') }}"></script>
</head>
<body>  
    <h1>Blockly Python Editor</h1>
    <button onclick="runCode()">Run Code</button>
    <button onclick="downloadCode()">Download Python File</button>

    <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>    
    <textarea id="codeArea" style="width: 100%; height: 100px;"></textarea>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var workspace = Blockly.inject('blocklyDiv', {
                toolbox: `<xml>
                <category name="Cơ bản" colour="160">
                    <block type="print"></block>
                    <block type="input"></block>
                    <block type="math_arithmetic"></block>
                </category>
                <category name="Điều kiện" colour="210">
                    <block type="if_else"></block>
                </category>
                <category name="Vòng lặp" colour="120">
                    <block type="for_loop"></block>
                </category>
              </xml>`
            });

            function generateCode() {
                var code = Blockly.Python.workspaceToCode(workspace);
                document.getElementById("codeArea").value = code;
            }

            function runCode() {
                var code = document.getElementById("codeArea").value;
                fetch('/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                }).then(response => response.text())
                  .then(output => alert(output));
            }

            function downloadCode() {
                var code = document.getElementById("codeArea").value;
                var blob = new Blob([code], { type: "text/python" });
                var link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "generated_code.py";
                link.click();
            }

            workspace.addChangeListener(generateCode);
        });
    </script>
        <script defer src="{{ url_for('static', filename='custom_blocks.js') }}"></script>
        <script defer src="{{ url_for('static', filename='custom_python.js') }}"></script>
</body>
</html>
